{% extends "layout.html" %}

{% block title %}Master Sheet{% endblock %}

{% block breadcrumb %}Master Sheet{% endblock %}
{% block breadcrumb-item %}Master Sheet{% endblock %}
{% block css %}
<style>
    #actual-btn-label{
        display: inline-block;
        background-color: rgb(0, 9, 130);
        color: white;
        padding: 0.5rem;
        font-family: sans-serif;
        border-radius: 0.3rem;
        cursor: pointer;
        margin-top: 1rem;
    }

    #file-chosen{
        margin-left: 0.3rem;
        font-family: sans-serif;
    }
</style>
{% endblock %}
{% block content %}
<div id="main_content">
    <div class="offset-md-8">
        <form method="POST" action="{% url 'uploadMasterSheet' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" name = 'file' id="id_file" required hidden/>
            <label id="actual-btn-label" for="id_file">Choose File</label>
            <span id="file-chosen">No file chosen</span>
            <button class="btn btn-primary " type="submit" value="Upload">Upload</button>
        </form>
    </div>
    <br/>
    <div class="row">
        <table id="ms_table" class="ableau table datatable table-fixed table-bordered table-hover">
            <thead>
                <tr>
                   <th>No</th>
                   <th>Name of sheet</th>
                   <th>Date&time</th>
                   <th>Status</th>
                   <th></th>
                </tr>
             </thead>
             <tbody>
                {% for sheet in sheets %}
               
                    <tr user_id="{{ sheet.id }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ sheet.name }}</td>
                        <td>{{ sheet.upload_date }}</td>
                        <td>
                            {% if sheet.status == 1 %}
                                active
                            {% else %}
                                inactive
                            {% endif %}
                        </td>
                        <td ></td>
                    </tr>
                {% endfor %}
             </tbody>
        </table>
    </div>
</div>

<div class="modal" id="delModal">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
  
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">Modal Heading</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
  
        <!-- Modal body -->
        <div class="modal-body">
          Are you sure to delete?
        </div>
  
        <!-- Modal footer -->
        <div class="modal-footer">
            <button type="button" id="del_btn" data-bs-dismiss="modal" class="btn btn-primary">Ok</button>
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        </div>
  
      </div>
    </div>
</div>

{% endblock %}
{% block script %}
<script>
    $().ready(function() {
        var del_id = -1;
        var table = $('#ms_table').DataTable({
            columnDefs: [
                {
                    "targets": -1,
                    'render': function(data, type, row, meta) {
                        // console.log(row);
                        let active = row[3] != 'active' ? 'Activate' : 'De-activate';
                        return `<div class="select">
                                    <select id="standard-select">
                                        <option value="">Action</option>
                                        <option value="${active}">${active}</option>
                                        <option value="delete">delete</option>
                                    </select>
                                    <span class="focus"></span>
                                </div>`;
                    }
                }
            ],
        });
    
        const actualBtn = document.getElementById('id_file');
    
        const fileChosen = document.getElementById('file-chosen');
    
        actualBtn.addEventListener('change', function(){
        fileChosen.textContent = this.files[0].name
        })


        $('select').change(function() {
            // var table = $('#users_table').DataTable();

            val = this.value;
            id = $(this).parent().parent().parent().attr('user_id');
            tr = $(this).parent().parent();
            select = $(this);

            let url = '';
            let type = '';
            if (val == 'delete') {
                type = 'delete';
                del_id = id;
            } else if (val == 'De-activate') {
                type = 'de-activate';
                url = "{% url 'operateUser' %}";
            } else if (val == 'Activate') {
                type = 'activate';
                url = "{% url 'operateUser' %}";
            }
            
            $.ajaxSetup({
                headers: {
                    "X-CSRFToken": csrftoken
                }
            });

            if (type == 'activate' || type == 'de-activate') {
                $.ajax({
                    type: 'POST',
                    url: url,
                    data: {id: id, type: type},
                    success: function(res) {
        
                        if (res.msg == 'activated') {
                            toastr.success('user activated successfully!');
                            tr.siblings()[3].innerHTML = 'active';

                            var new_select = `
                                    <div class="select">
                                        <select id="standard-select">
                                            <option value="">Aption</option>
                                            <option value="De-activate">De-activate</option>
                                            <option value="view">View/Edit</option>
                                            <option value="delete">delete</option>
                                        </select>
                                        <span class="focus"></span>
                                    </div>
                            `;
                            select.html(new_select);
                        }
                        if (res.msg == 'de-activated') {
                            toastr.success('user de-activated successfully!');
                            tr.siblings()[3].innerHTML = 'inactive';

                            var new_select = `
                                    <div class="select">
                                        <select id="standard-select">
                                            <option value="">Aption</option>
                                            <option value="Activate">Activate</option>
                                            <option value="view">View/Edit</option>
                                            <option value="delete">delete</option>
                                        </select>
                                        <span class="focus"></span>
                                    </div>
                            `;
                            select.html(new_select);
                        }
                    },
                    error: function(res) {
                        toastr.error('error occured while processing.');
                    }
                });
            } else if (type == 'delete') {
                $('#delModal').modal('show');
            } 
        });
    });
</script>
{% endblock %}